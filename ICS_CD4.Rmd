---
title: "Total CD4 Data"
output:
  html_document: default
  html_notebook: default
---
This will be the markdown file looking at total CD4 phenotypes from the unstimulated condition

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE, message=FALSE, warning=FALSE, comment=NA)
library(dplyr)
library(knitr)
library(ggplot2)
library(gridExtra)
library(GGally)
library(ggpubr)
library(cowplot)
```

```{r}
source("/Users/tarynam/Desktop/Miscellaneous-Scripts/tryna function.R")
source("/Users/tarynam/Desktop/Miscellaneous-Scripts/pvals_TB-SM.R")
source("/Users/tarynam/Desktop/Miscellaneous-Scripts/plot_functions.R")
```

```{r}
setwd("/Applications/Old Computer/Day Lab/Flow-Data/clean/")
cd4<-read.csv("ICS_CD4_clean.csv")
    #since we don't care about the yerkes donors in our analysis and they mess everything up
    #we will filter them out
    data<-filter(cd4, SM!="N")
    #and then re-level both the SM and TB variable to not confuse our functions
    data$SM<-factor(data$SM, levels=c("X","SM"))
    data$TB<-factor(data$TB, levels=c("HC","LTBI","TB"))
cd4<-data
```

##Test and Return Significant Differences
This will run through each column, and test the relevant comparisons for statistical significance. It also corrects when multiple comparisons are made. Since Healthy Controls are only compared internally, they do not get included in the multiple testing comparison. The function only returns the comparisons that have an initial p-value less than 0.05, which reduces clutter. Everything else is insignificant.
```{r}
library(knitr)
#creates a list of character strings for each of the columns of interest
colnames<-names(dplyr::select(cd4, -X, -Sample, -Donor, -Stim, -TB, -SM))
for(col in colnames){#this will loop through each character string in the list
    a<-subset(cd4, cd4$Stim=="UN") #subsets the data to only contain the unstimulated samples
    #inserts each character string into the column argument of the pvals function written above
    b<-pvals_6(a, col)
    if(dim(b)[1]!=0)
    print(kable(b, caption=col)) #will return the output for each character string in the loop
}
```

##Graph things that are significant
Since SM- and SM+ are literally only different (p<0.05 after corrections) in Healthy Controls, I've graphed only those. It makes sense to me to graph it this way but am open to suggestions. We can start with a claim like "S mansoni on it's own has an influence on ____."  

####Option 1
```{r, fig.width=8, fig.height=8}
data<-filter(cd4, cd4$Stim=="UN", cd4$TB=="HC")
a<-plot_hc(data, "SM", "CXCR3")+labs(title="Surface Marker Expression", subtitle="TH1")
b<-plot_hc(data, "SM", "CCR4")+labs(title=" ", subtitle="TH2")
c<-plot_hc(data, "SM", "Tbet")+labs(title="Transcription Factor Expression", subtitle="TH1")
d<-plot_hc(data, "SM", "GATA3")+labs(title=" ",subtitle="TH2")
plot_grid(a,b,c,d, ncol=2)
```

####Option 2
```{r, fig.width=8, fig.height=8}
a<-plot_hc(data, "SM", "CXCR3")+labs(title="TH1", subtitle="Surface Marker")
b<-plot_hc(data, "SM", "Tbet")+labs(title=" ", subtitle="Transcription Factor")
c<-plot_hc(data, "SM", "CCR4")+labs(title="TH2", subtitle="Surface Marker")
d<-plot_hc(data, "SM", "GATA3")+labs(title=" ", subtitle="Transcription Factor")
plot_grid(a,b,c,d, ncol=2 )
```

##All Possible Graphs
For posterity... But I doubt we will include any of these

###MFI
```{r}
for(col in colnames[1:4]){#this will loop through each character string in the list
    x<-subset(cd4, cd4$Stim=="UN") #subsets the data to only contain the unstimulated samples
    #inserts each character string into the column argument of the pvals function written above
    y<-plot_6(x, "SM", col)+
        labs(subtitle=paste(gsub("_", " ", col), "on CD4+ T cells"), 
             caption="",
             x="",
             y=gsub("_", " ", col))
    print(y) #will return the output for each character string in the loop
}
```


###Surface Markers
```{r}
for(col in colnames[5:10]){#this will loop through each character string in the list
    x<-subset(cd4, cd4$Stim=="UN") #subsets the data to only contain the unstimulated samples
    #inserts each character string into the column argument of the pvals function written above
    name<-gsub(".P", "+", col)
    name<-gsub("_","", name)
    name<-gsub(".N", "-", name)
    y<-plot_6(x, "SM", col)+
        labs(subtitle=paste(name, "(% CD4+ T cells)"), 
             caption="",
             x="",
             y=paste(name, "(% CD4+ T cells)"))
    print(y) #will return the output for each character string in the loop
}
```


###Transcription Factors

As you can see there is one crazy looking "outlier" in GATA3 from NK2586. 
```{r}
for(col in colnames[11:16]){#this will loop through each character string in the list
    x<-subset(cd4, cd4$Stim=="UN") #subsets the data to only contain the unstimulated samples
    #inserts each character string into the column argument of the pvals function written above
    name<-gsub(".P", "+", col)
    name<-gsub("_","", name)
    name<-gsub(".N", "-", name)
    y<-plot_6(x, "SM", col)+
        labs(subtitle=paste(name, "(% CD4+ T cells)"), 
             caption="",
             x="",
             y=paste(name, "(% CD4+ T cells)"))
    print(y) #will return the output for each character string in the loop
}
```

#Side Note
This is the statistical evaluation of the data set without NK2586 the outlier GATA3 donor to see if it makes a difference.
```{r}
colnames2<-colnames[grep("GATA", colnames)]
for(col in colnames2){#this will loop through each character string in the list
    a<-filter(cd4, Stim=="UN", Donor!="NK2586") #subsets the data to only contain the unstimulated samples
    #inserts each character string into the column argument of the pvals function written above
    b<-pvals_6(a, col)
    if(dim(b)[1]!=0)
    print(kable(b, caption=col)) #will return the output for each character string in the loop
}
```



