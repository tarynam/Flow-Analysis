---
title: "Untitled"
author: "Taryn McLaughlin"
date: "11/30/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#P-value Functions

```{r}
# a function to evaluate differences in the expression of a marker (designated by the "column" argument) between disease groups
pvals_helminth<-function(data, column){
    
    x<-split(data,data$TB) #creates individual dataframes for each level of TB
    #does a wilcox test for the column of interest comparing SM- to SM+ within each level of TB
    A<-lapply(x, function(g) wilcox.test(g[,column]~g[,"SM"], exact=FALSE))
    
    y<-split(data,data$SM) #creates two dataframes for SM- and SM+
    #each lapply does a wilcox test on subsets these dataframes to compare 2 levels of TB
    #stores the output in a variable. So B will contain the comparison of HC to LTBI for both SM- and SM+
    B<-lapply(y, function(g) 
        wilcox.test((g[,column]~g[,"TB"]), subset=g$TB %in% c("HC", "LTBI"), exact=FALSE))
    C<- lapply(y, function(g) 
        wilcox.test((g[,column]~g[,"TB"]), subset=g$TB %in% c("LTBI", "TB"), exact=FALSE))
    D<- lapply(y, function(g) 
        wilcox.test((g[,column]~g[,"TB"]), subset=g$TB %in% c("HC", "TB"), exact=FALSE))
    
    #To keep track of all the p-values... these should match the order below
    labels<-c("HC SM+ to HC SM-", "LTBI SM+ to LTBI SM-", "TB SM+ to TB SM-",
              "HC SM+ to LTBI SM+", "LTBI SM+ to TB SM+", "HC SM+ to TB SM+",
              "HC SM- to LTBI SM-", "LTBI SM- to TB SM-", "HC SM- to TB SM-"
    )
    
    #extract the p-values from all the stored wilcox tests
    pvals<-c(A$HC$p.value, A$LTBI$p.value, A$TB$p.value,
             B$SM$p.value, C$SM$p.value,  D$SM$p.value,
             B$X$p.value,  C$X$p.value,   D$X$p.value)
    
    #adjusts the p-values using the false discovery rate strategy
    fdr_adj_pvals<-round(p.adjust(pvals, method="fdr"), 4)
    
    #create a table with the output
    table<-(cbind(labels, round(pvals, 4), fdr_adj_pvals))
    colnames(table)<-c("Comparison", paste(column,"p-values"," "), 
                       "FDR Corrected")
    table #return the table
}
```

#Read in Data
```{r}
library(dplyr)
setwd("/Applications/Old Computer/Day Lab/Flow-Data/clean/")
Cyt<-read.csv("CD4_Cytokine_clean.csv")
    data<-filter(Cyt, SM!="N")
    data$SM<-factor(data$SM, levels=c("X","SM"))
    data$TB<-factor(data$TB, levels=c("HC","LTBI","TB"))
Cyt<-data

MFI<-read.csv("CD4_MFI_clean.csv")
    data<-filter(MFI, SM!="N")
    data$SM<-factor(data$SM, levels=c("X","SM"))
    data$TB<-factor(data$TB, levels=c("HC","LTBI","TB"))
MFI<-data

Compass<-read.csv("ICS_Compass_scores_complete.csv")
    data<-filter(Compass, SM!="N")
    data$SM<-factor(data$SM, levels=c("X","SM"))
    data$TB<-factor(data$TB, levels=c("HC","LTBI","TB"))
Compass<-data
```

#Standard Analysis
This will literally p-value the frequencies of every cytokine subset as well as combination gate from my elaborate gating strategy.

##PMA
```{r}
library(dplyr)
library(knitr)
DF<-Cyt
colnames<-names(dplyr::select(DF, -Sample, -Donor, -Stim, -TB, -SM)[1:16])
colnames<-names(dplyr::select(DF, -Sample, -Donor, -Stim, -TB, -SM))
for(col in colnames){
    x<-subset(DF, DF$Stim=="PMA")
    y<-pvals_helminth(x, col)
    print(y)
}
```

##PEP
```{r}
library(dplyr)
library(knitr)
DF<-Cyt
colnames<-names(dplyr::select(DF, -X, -Sample, -Donor, -Stim, -TB, -SM))
for(col in colnames){
    x<-subset(DF, DF$Stim=="PEP")
    y<-pvals_helminth(x, col)
    print(y)
}
```

##WCL
```{r}
library(dplyr)
library(knitr)
DF<-Cyt
colnames<-names(dplyr::select(DF, -X, -Sample, -Donor, -Stim, -TB, -SM))
for(col in colnames){
    x<-subset(DF, DF$Stim=="WCL")
    y<-pvals_helminth(x, col)
    print(y)
}
```

##SEA
```{r}
library(dplyr)
library(knitr)
DF<-Cyt
colnames<-names(dplyr::select(DF, -X, -Sample, -Donor, -Stim, -TB, -SM))
for(col in colnames){
    x<-subset(DF, DF$Stim=="SEA")
    y<-pvals_helminth(x, col)
    print(y)
}
```

##SWAP
```{r}
library(dplyr)
library(knitr)
DF<-Cyt
colnames<-names(dplyr::select(DF, -X, -Sample, -Donor, -Stim, -TB, -SM))
for(col in colnames){
    x<-subset(DF, DF$Stim=="SWAP")
    y<-pvals_helminth(x, col)
    print(y)
}
```

#Compass Scores
The actually data processessing is done elsewhere because it's computationally intensive and is stored locally. This simply analyzes the output data.

```{r}
library(dplyr)
library(knitr)
#Since there are only two parameters of interest this is pretty straightforward, 
#we don't need elaborate loops
#we split the data by celltype (since GD and CD8 data is included) and stim
x<-split(Compass, list(Compass$celltype, Compass$Stim))
#and apply over the subsequent list of dataframes the pvals function to see if FS is different between disease groups
y<-lapply(x, function(g) pvals_helminth(g, "FS"))
y
#or if the PFS is different between disease groups
z<-lapply(x, function(g) pvals_helminth(g, "PFS"))
z
```

#Cytokine MFI
During the cleaning phase of this project (see ICS_Cleaning.Rmd), cytokine MFI values were set to NA if there were fewer than 20 cells contributing to that MFI value. As such, we can only make statistical comparisons between groups when the groups contain enough observed values. I have annotated this code for PMA only but the mechanism is the same for other stims.

##PMA
```{r}
library(dplyr)
library(knitr)
kable(colSums(!is.na(MFI)))
#since the extent of missingness varies by stim we have to do this each time
DF<-subset(MFI, MFI$Stim=="PMA")
#split by both TB and SM so you have a list of 6 data frames- each of which is a group of interest
x<-split(DF, list(DF$TB, DF$SM))
#for each dataframe in the list, return the column names of the columns where the sum of the number of rows that do not have missing data is more than 0. It's a weird double negative. But basically makes a list of the columns that have sufficient data.
y<-lapply(x, function(g) names(g[, colSums(!is.na(g)) > 0]))
#each entry in the list has to be extracted and named
a<-unlist(y[1])
b<-unlist(y[2])
c<-unlist(y[3])
d<-unlist(y[5])
e<-unlist(y[6])
#then find the intersection of all the lists. Aka which column names have sufficient data in all 6 TB-SM groups
colnames<-intersect(intersect((intersect(intersect(a,b),c)),d),e)
#this will also include metadata so we remove those column names and can phenotype using the standard pvals function from the beginning
colnames<-colnames[7:length(colnames)]
for(col in colnames){
    y<-pvals_helminth(DF, col)
    print(y)
}
```

##PEP
```{r}
library(dplyr)
library(knitr)
DF<-subset(MFI, MFI$Stim=="PEP")
x<-split(DF, list(DF$TB, DF$SM))
y<-lapply(x, function(g) names(g[, colSums(!is.na(g)) > 0]))
a<-unlist(y[1])
b<-unlist(y[2])
c<-unlist(y[3])
d<-unlist(y[5])
e<-unlist(y[6])
colnames<-intersect(intersect((intersect(intersect(a,b),c)),d),e)
colnames<-colnames[7:length(colnames)]
for(col in colnames){
    y<-pvals_helminth(DF, col)
    print(y)
}
```

##WCL
```{r}
library(dplyr)
library(knitr)
DF<-subset(MFI, MFI$Stim=="WCL")
x<-split(DF, list(DF$TB, DF$SM))
y<-lapply(x, function(g) names(g[, colSums(!is.na(g)) > 0]))
a<-unlist(y[1])
b<-unlist(y[2])
c<-unlist(y[3])
d<-unlist(y[5])
e<-unlist(y[6])
colnames<-intersect(intersect((intersect(intersect(a,b),c)),d),e)
colnames<-colnames[7:length(colnames)]
for(col in colnames){
    y<-pvals_helminth(DF, col)
    print(y)
}
```

##SEA
```{r}
library(dplyr)
library(knitr)
DF<-subset(MFI, MFI$Stim=="SEA")
x<-split(DF, list(DF$TB, DF$SM))
y<-lapply(x, function(g) names(g[, colSums(!is.na(g)) > 0]))
a<-unlist(y[1])
b<-unlist(y[2])
c<-unlist(y[3])
d<-unlist(y[5])
e<-unlist(y[6])
colnames<-intersect(intersect((intersect(intersect(a,b),c)),d),e)
colnames<-colnames[7:length(colnames)]
for(col in colnames){
    y<-pvals_helminth(DF, col)
    print(y)
}
```

##SWAP
```{r}
library(dplyr)
library(knitr)
DF<-subset(MFI, MFI$Stim=="SWAP")
x<-split(DF, list(DF$TB, DF$SM))
y<-lapply(x, function(g) names(g[, colSums(!is.na(g)) > 0]))
a<-unlist(y[1])
b<-unlist(y[2])
c<-unlist(y[3])
d<-unlist(y[5])
e<-unlist(y[6])
colnames<-intersect(intersect((intersect(intersect(a,b),c)),d),e)
colnames<-colnames[7:length(colnames)]
for(col in colnames){
    y<-pvals_helminth(DF, col)
    print(y)
}
```
